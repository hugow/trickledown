<html>
<head>
<link rel="StyleSheet" href="stylesheets/site.css" type="text/css" media="screen">
<link type="text/css" href="stylesheets/ui-lightness/jquery-ui-1.8.16.custom.css" rel="Stylesheet" />
<script type="text/javascript" src="javascripts/jquery-1.6.2.min.js"></script>
<script type="text/javascript" src="javascripts/jquery-ui-1.8.16.custom.min.js"></script>
<script type="text/javascript" src="javascripts/gcharts/jquery.gchart.js"></script>
<script>
    $(document).ready(function () {
        var singleId = 0;
        $( "#tabs" ).tabs();

        function getSingleId() {
            var ret = 'id' + singleId;
            singleId += 1;
            return ret;
        }
        function updateHistogram(world, histogram) {
            // chart 1
            $('div.' + world + ' div.worldchart1').gchart({
                title: '% of total money per wealth category',
                type: 'barVert',
                dataLabels: histogram.dataLabels,
                legend: 'right',
                series: [
                    $.gchart.series('% of total money', histogram.percent, 'green', 0, 1)
                ]
            });
            // chart 2
            $('div.' + world + ' div.worldchart2').gchart({
                title: 'Number of Players per wealth category',
                type: 'barVert',
                dataLabels: histogram.dataLabels,
                legend: 'right',
                series: [
                    $.gchart.series('Number of People', histogram.number, 'green', 0, 100)
                ]
            });
        }

        function updateRanking(world, values) {
            var str = '<table>', i;
            for (i = 0; i < values.length; i += 1) {
                str += '<tr><td>' + values[i].username + '</td><td>' + values[i].value + '$</td></tr>';
            }
            str += '</table>';
            $('div.' + world + ' div.playerranking').html(str);
        }

        function updateOtherStats(world, values) {
            var str = '<table>', i;
            for (i = 0; i < values.length; i += 1) {
                str += '<tr><td>' + values[i].name + '</td><td>' + values[i].value + '</td></tr>';
            }
            str += '</table>';
            $('div.' + world + ' div.otherstats').html(str);
        }

        function updatePlayerStats(world, values) {
            var str = '<table>', i;
            for (i in values) {
                str += '<tr><td>' + i + '</td><td>' + values[i] + '</td></tr>';
            }
            str += '</table>';
            $('div.' + world + ' div.ranking').html(str);
        }

        function createSliderBox(containerSelector, boxdescr, whenSliderChanges) {
            var g = $(containerSelector).append('<div class = "sliderbox"></div>'),
                result = {};
            result.sliders = {};
            // the title
            g.append('<h2>' + boxdescr.title + '<h2>');
            // for all settings
            boxdescr.settings.forEach(function (setting) {
                var fn = setting.fieldName, sid = getSingleId();
                g.append('<p>' + setting.label + '</p>');
                g.append('<div class = "' + sid + '"></div>');
                $('div.' + sid).slider({
                    max: 100,
                    stop: function(event, ui) {
                        console.log(' NEW VALUE FOR ' + fn + ': ' + boxdescr.title + ', ' + containerSelector + ' ' + sid + ' ' + $('div.' + sid).slider('value'));
                        result.changed();
                    }
                });
                result.sliders[fn] = sid;
            });

            result.setValues = function (o) {
                var p, rs = result.sliders;
                for (p in o) {
                    if (o.hasOwnProperty(p)) {
                        $('div.' + rs[p]).slider('value', o[p] * 100);
                    }
                }
            };

            result.getValues = function () {
                var o = { }, p, rs = result.sliders;
                for (p in rs) {
                    if (rs.hasOwnProperty(p)) {
                        o[p] = $('div.' + rs[p]).slider('value') / 100;
                    }
                }
                return o;
            };
            result.changed = whenSliderChanges;

            return result;
        }

        function createUserSliders(world) {
            var voting = {
                    title: "Voting Profile",
                    settings: [
                        { label: "Tax % for the richest", fieldName: "taxTheRich" },
                        { label: "Tax % for the poorest", fieldName: "taxThePoor" },
                        { label: "Redistribute to corporations", fieldName: "redistributeToCorporations" }
                    ]
                },
                spending = {
                    title: "Spending Profile",
                    settings: [
                        { label: "Spend on education", fieldName: "education" },
                        { label: "Spend on savings", fieldName: "savings" },
                        { label: "Spend on invesments", fieldName: "stocks" },
                        { label: "Spend on goods", fieldName: "goods" }
                    ]
                },
                stocks = {
                    title: "tbd",
                    settings: [
                        { label: "Research", fieldName: "technology" },
                        { label: "Growth & Salaries", fieldName: "size" },
                        { label: "Lobbying", fieldName: "lobbying" }
                    ]
                },
                stockTypes = [ "wood", "metal", "drugs", "electronics", "cars", "cinema", "software" ],
                selector = '#tabs-2 div.' + world + ' div.worldinner' + ' div.sliders',
                results = {};
            $(selector).html('');

            function whenSliderChanges() {
                var toSend = results.getProfiles(),
                    username = $('#username').val(),
                    password = $('#password').val();

                $.ajax({
                    url: '/worlds/' + world + '/players/' + username + '/profiles?password=' + escape(password),
                    type: "POST",
                    dataType: 'text',
                    data: toSend,
                    success: function (data) {
                        console.log("POST RESULT : " + data);
                    },
                    error: function () {
                        console.log('save error');
                    }
                });
            }

            results.voting = createSliderBox(selector, voting, whenSliderChanges);
            results.spending = createSliderBox(selector, spending, whenSliderChanges);
            results.stocks = {};
            stockTypes.forEach(function (stock) {
                stocks.title = "Stock: " + stock;
                results.stocks[stock] = createSliderBox(selector, stocks, whenSliderChanges);
            });
            results.show = function (visible) {
                $(selector).css({display: visible ? 'block' : 'none'});
            }
            results.setProfiles = function (profiles) {
                results.voting.setValues(profiles.votingProfile);
                results.spending.setValues(profiles.spendingProfile);
                var p, prof = profiles.investmentProfile;
                for (p in prof) {
                    if (prof.hasOwnProperty(p)) {
                        results.stocks[p].setValues(prof[p]);
                    }
                }
            };
            results.getProfiles = function (profiles) {
                var rep = {}, p;
                rep.votingProfile = results.voting.getValues();
                rep.spendingProfile = results.spending.getValues();
                rep.investmentProfile = {};
                stockTypes.forEach(function (p) {
                    rep.investmentProfile[p] = results.stocks[p].getValues();
                });
                return rep;
            }
            results.clear = function () {
                $(selector).html('');
            };
            return results;
        }

        function setupInteraction() {
            var opovSliders,
                odovSliders,
                username,
                password;

            $('#login').bind('click', function () {
                username = $('#username').val();
                password = $('#password').val();
                if (opovSliders) {
                    opovSliders.clear();
                }
                if (odovSliders) {
                    odovSliders.clear();
                }
                $.ajax({
                    url: '/worlds/opov/players/' + username + '/profiles?password=' + escape(password),
                    type: "GET",
                    dataType: 'json',
                    success: function (data) {
                        opovSliders = createUserSliders('opov');
                        opovSliders.setProfiles(data);
                    },
                    error: function () {
                        //alert('invalid login');
                    }
                });

                $.ajax({
                    url: '/worlds/odov/players/' + username + '/profiles?password=' + escape(password),
                    type: "GET",
                    dataType: 'json',
                    success: function (data) {
                        odovSliders = createUserSliders('odov');
                        odovSliders.setProfiles(data);
                    },
                    error: function () {
                        //alert('invalid login');
                    }
                });

            });
        }

        function setupSimulation () {
            var requests = [];
            // set an interval to reload the world (we know it updates constantly,
            // there is no point in being notified)
            setInterval(function () {
                var username = $('#username').val();
                // abort all pending ajax requests
                requests.forEach(function (req) {
                    req.abort();
                });
                // queue more requests
                requests.push($.get('/worlds/opov',
                    function (data, textStatus, jqXHR) {
                        updateHistogram('opov', data.moneyDistribution);
                        updateRanking('opov', data.topPlayers);
                        updateOtherStats('opov', [ { name: 'test', value: 'v' }]);
                        updateOtherStats('opov', data.statistics);
                    },
                    'json'
                ));
                requests.push($.get('/worlds/odov',
                    function (data, textStatus, jqXHR) {
                        updateHistogram('odov', data.moneyDistribution);
                        updateRanking('odov', data.topPlayers);
                        updateOtherStats('odov', data.statistics);
                    },
                    'json'
                ));
                if (username) {
                    requests.push($.get('/worlds/odov/players/' + username,
                        function (data, textStatus, jqXHR) {
                            updatePlayerStats('odov', data);
                        },
                        'json'
                    ));
                    requests.push($.get('/worlds/opov/players/' + username,
                        function (data, textStatus, jqXHR) {
                            updatePlayerStats('opov', data);
                        },
                        'json'
                    ));
                }



            }, 3300);
        }
        setupSimulation();
        setupInteraction();
    });
</script>
</head>
<body>
    <div id = 'outerzone'>
        <div id = 'appzone'>
            <div id = 'headerzone'>
                <div class='bigtitle'>TrickleDown</div>
                <div class='smalltitle'>too big to fail</div>
            </div>
            <div id = 'mainzone'>

                <div class="demo">
                    <div id="tabs">
	                    <ul>
		                    <li><a href="#tabs-1">World</a></li>
		                    <li><a href="#tabs-2">Play</a></li>
		                    <li><a href="#tabs-3">About</a></li>
	                    </ul>
	                    <div id="tabs-1" class='myThing'>
	                        <p>TrickleDown is an economic simulation, a game and
	                        an experiment at the same time. There are two
	                        worlds: the first one gives everyone an equal vote
	                        and the second one gives wealthier people
	                        more voting power.</p>

	                        <p>Voting lets you decide who should be taxed, the
	                        rich or the poor and how the money will be spent:
	                        by redistributing equally to all citizens or by
	                        helping the corporations in hope that they will
	                        give better opportunities to everyone in return.</p>

	                        <p>What world will be more succesful? If you play,
	                        remember that your goal is climb to the top by spending
	                        as much as possible on goods (the top player is the top
	                        consumer) and
	                        to stay there.</p>

	                        <div class='opov'>
	                            <div class='worldinner'>
	                                <h2>One man one vote</h2>

	                                <div class = 'sectioncomment' >
	                                    Top Players
	                                </div>
	                                <div class = 'playerranking'>

	                                </div>

	                                <div class = 'sectioncomment' >
	                                    Percent of Total Money per Wealth Category
	                                </div>
	                                <div class='worldchart1'> </div>


	                                <div class = 'sectioncomment' >
	                                    People per Wealth Category
	                                </div>
	                                <div class='worldchart2'> </div>


	                                <div class = 'sectioncomment' >
	                                    Other stats
	                                </div>
	                                <div class='otherstats'> </div>
                                </div>
	                        </div>
	                        <div class='odov'>
	                            <div class='worldinner'>
	                                <h2>One dollar one vote</h2>

	                                <div class = 'sectioncomment' >
	                                    Top Players
	                                </div>
	                                <div class = 'playerranking'>

	                                </div>

	                                <div class = 'sectioncomment' >
	                                    Percent of Total Money per Wealth Category
	                                </div>
	                                <div class='worldchart1'> </div>


	                                <div class = 'sectioncomment' >
	                                    People per Wealth Category
	                                </div>
	                                <div class='worldchart2'> </div>


	                                <div class = 'sectioncomment' >
	                                    Other stats
	                                </div>
	                                <div class='otherstats'> </div>
                                </div>
	                        </div>
	                    </div>
	                    <div id="tabs-2">
		                    <p>Use a username and password of your choice
		                    then control the corresponding character. Your
		                    ranking is determined by the amount you spend
		                    on goods at each simulation cycle.</p>
		                    Username <input type='text' id = 'username' />
		                    Password <input type='password' id = 'password' />
		                    <input type="button" value="Play!" id = 'login' />

                            <div class='opov'>
                                <div class='worldinner'>
	                                <h2>One man one vote</h2>
	                                <div class='ranking'></div>
	                                <div class='sliders'></div>
                                </div>
	                        </div>
                            <div class='odov'>
                                <div class='worldinner'>
	                                <h2>One dollar one vote</h2>
	                                <div class='ranking'></div>
	                                <div class='sliders'></div>
	                            </div>
	                        </div>


	                    </div>
	                    <div id="tabs-3">
		                    <p>To play enter a username and password and
		                    assign your priorites to the various entries.
		                    Come back periodically to see the ranking of
		                    your player.</p>
	                    </div>
                    </div>

                </div><!-- End demo -->

            </div>
        </div>
    </div>
</body>
</html>
